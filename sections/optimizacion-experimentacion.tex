\section{Optimización y experimentación}
En la siguiente sección, se evaluará el rendimiento de la base de datos mediante la ejecución de tres consultas complejas. Este análisis se llevará a cabo en varios escenarios que incluyen diferentes volúmenes de datos, y se realizarán pruebas sin índices, únicamente con los índices por defecto y con los índices que consideremos más adecuados para garantizar la ejecución óptima de estas consultas. Finalmente, se procederá a analizar y comparar los resultados obtenidos.
\subsection{Consultas SQL para el experimento}
\subsubsection{Descripción del tipo de consultas seleccionadas} % TODO: Revisar todas las descripciones y justificación.
\begin{itemize}
      \item{\textbf{Consulta 1}: La siguiente consulta obtiene el nombre, email y número de celular de los directores actuales, así como la dirección, coordenadas y fecha de construcción de las 20 sedes más antiguas construidas entre 1990 y 2010, excluyendo aquellas sedes donde el número total de profesores y alumnos exceda 400.}
            \begin{itemize}
                  \item{\textbf{Justificación}: La institución educativa está en un proceso de planificación para realizar renovaciones y mantenimiento en sus sedes. Se ha decidido comenzar con las sedes construidas entre los años 1990 y 2010, ya que estas son las que han demostrado tener más necesidad de atención. Para minimizar las interrupciones en las actividades escolares, se ha establecido que solo se seleccionarán aquellas sedes donde la suma del número de profesores y alumnos no exceda 400. Además, se requiere la información de los directores de estas sedes para coordinar las visitas de evaluación y supervisión.}
            \end{itemize}
      \item{\textbf{Consulta 2}: Se desea conocer el nombre completo, bonificación, código de cuenta interbancaria e email de los colaboradores identificados como activos actualmente a los que les corresponde el bono que ofrece la institución. Para calcular la bonificación debemos tomar en cuenta que las sedes que este año están cumpliendo un aniversario múltiplo de 10 (sin contar al 0) ofrecen un bono de 5\% respecto al pago mensual (el sueldo mensual se obtiene cuadruplicando la multiplicación del pago por hora por las horas semanales) para sus colaboradores que nacieron entre 1960 y 1980.}
            \begin{itemize}
                  \item{\textbf{Justificación}: La institución educativa tiene una política que consiste en que cada 10 años desde la construcción de cada sede se ofrece un bono de 5\% respecto al pago mensual, a los colaboradores activos mayores que trabajan en esa sede. Para obtener el monto de bonificación se debe cuadruplicar la multiplicación de la remuneración establecida por hora por la cantidad de horas semanales laboradas. De existir un colaborador que labore en más de una sede se debe evaluar la condición del aniversario para todas las sedes; si se cumple la condición en más de una, debemos multiplicar el bono por el número de sedes en las que se cumpla. El área de finanzas debe realizar el desembolso de este bono; por ello, se necesita conocer el nombre completo, monto respectivo, código de cuenta interbancaria para realizar la transferencia de este, y su email para enviar el comprobante de pago. }
            \end{itemize}
      \item{\textbf{Consulta 3}: Se desea conocer el nombre, primer apellido, segundo apellido, sexo e email de los alumnos menores de 18 años cuyo apoderado sea un colaborador registrado como activo, que trabaja a tiempo completo (más de 48 horas semanales) y cuyo sueldo mensual sea menor a 2000 soles (el sueldo mensual se obtiene cuadruplicando la multiplicación del pago por hora por las horas semanales). Además deben haber transcurrido como mínimo 2 años desde la matrícula del alumno.}
            \begin{itemize}
                  \item{\textbf{Justificacion}: La institución educativa implementará la iniciativa de ofrecer un descuento especial en el pago mensual a los alumnos menores de edad cuyo apoderado sea un colaborador activo de la institución que labore a tiempo completo y su sueldo mensual sea menor a 2000. El alumno debe haber estado matriculado por lo menos 2 años antes del actual.}
            \end{itemize}
\end{itemize}
\subsubsection{Implementación de consultas en SQL}
\begin{itemize}
      \item{\textbf{Consulta 1}:
            \lstinputlisting[language=SQL]{code-snippets/query-1/query_1.sql.}}
      \item{\textbf{Consulta 2}:
            \lstinputlisting[language=SQL]{code-snippets/query-2/query_2.sql}}
      \item{\textbf{Consulta 3}:
            \lstinputlisting[language=SQL]{code-snippets/query-3/query_3.sql}}
\end{itemize}
\subsection{Metodología del experimento}
\begin{sloppypar}
      Primero, creamos cuatro esquemas: ``mil\_datos'', ``diezmil\_datos'', ``cienmil\_datos'' y ``millon\_datos''. Cada uno de estos esquemas contiene la cantidad de datos que su nombre indica.
\end{sloppypar}
\lstinputlisting[language=SQL]{code-snippets/create_schemas.sql}
Luego, ejecutaremos cada consulta en cada uno de los esquemas, primero, sin índices, segundo, con los índices por defecto y, finalmente, con los índices por defecto más los índices que consideremos más adecuados para garantizar la ejecución óptima de estas consultas.\\
Finalmente, mediremos el tiempo de ejecución y analizaremos los planes de ejercución de cada consulta en cada uno de los escenarios mencionados.
\subsection{Optimización de consultas}
\subsubsection{Planes de índices para la primera consulta}
\begin{itemize}
      \item{Ejecución sin índices}
            \queryExecutionPlanGroup{code-snippets/query-1/query_1_unindexed.sql}{figures/query-1/query_1_unindexed_mil_datos.png}{figures/query-1/query_1_unindexed_diezmil_datos.png}{figures/query-1/query_1_unindexed_cienmil_datos.png}{figures/query-1/query_1_unindexed_millon_datos.png}
      \item{Ejercución con índices por defecto}
            \queryExecutionPlanGroup{code-snippets/query-1/query_1_indexed_default.sql}{figures/query-1/query_1_indexed_default_mil_datos.png}{figures/query-1/query_1_indexed_default_diezmil_datos.png}{figures/query-1/query_1_indexed_default_cienmil_datos.png}{figures/query-1/query_1_indexed_default_millon_datos.png}
      \item{Ejecución con índices por defecto más índices personalizados}
            \queryExecutionPlanGroup{code-snippets/query-1/query_1_indexed_custom.sql}{figures/query-1/query_1_indexed_custom_mil_datos.png}{figures/query-1/query_1_indexed_custom_diezmil_datos.png}{figures/query-1/query_1_indexed_custom_cienmil_datos.png}{figures/query-1/query_1_indexed_custom_millon_datos.png}
      \item{Descripción de las ejecuciones}
      \begin{itemize}
            \item {\textbf{Sin índices}: Los planes de consulta para las tablas de 1k y 1M son similares entre sí, con una operación extra de Gather en el millón de datos, mientras que los planes de 10k y 100k son similares pero difieren en comparación con los de 1k y 1M. Para 1k datos, se inicia con un Nested Loop Inner Join entre director y colaborador, seguido de otro Nested Loop Inner Join con persona y luego con sede. Las filas de sede se filtran usando un Seq Scan basado en sede.construccion\_fecha, y se ejecutan subconsultas ``SubQuery Scan'' para contar las filas de profesor\_sede y alumno, limitando el resultado a aquellos donde la suma no exceda de 400. Estos resultados se ordenan ``Sort'' por sede.construccion\_fecha y se limita la salida a 20 filas. Para 10k datos, se cambia el orden, comenzando con un Nested Loop Inner Join entre director y colaborador, seguido de un Seq Scan sobre sede y un Nested Loop Inner Join con persona, aplicando las mismas subconsultas y limitando los resultados de manera similar. En 100k datos, el plan es similar al de 10k, pero se utiliza Parallel Seq Scan para manejar el mayor volumen de datos eficientemente, manteniendo las subconsultas y la ordenación de resultados. En el millón de datos, se observan los mismos pasos que en 100k, pero con el uso adicional de Parallel Seq Scan y Gather después del join para consolidar los resultados de las operaciones paralelas. En todos los casos, los planes dependen de Nested Loop Inner Join y Seq Scan, pero se aprovechan de operaciones paralelas a medida que el tamaño de los datos aumenta.}
            \item {\textbf{Con índices por defecto}: Los planes de consulta para las tablas de 1k, 10k, 100k y 1M datos muestran diferencias significativas en los algoritmos utilizados. Para 1k datos, el plan comienza con un Seq Scan en sede, filtrando por construccion\_fecha y limitando con subconsultas que cuentan las filas de profesor\_sede y alumno. Luego, se realiza un Nested Loop con director y colaborador, seguido de un Index Scan en persona, usando quicksort para ordenar. En 10k datos, el plan también inicia con Seq Scan en sede, pero las subconsultas se ejecutan más frecuentemente, con múltiples Nested Loop y Index Scan, manteniendo quicksort para la ordenación. Para 100k datos, se introduce un Materialize y top-N heapsort para ordenar, utilizando intensivamente Nested Loop y Seq Scan, aumentando el costo por el mayor volumen de datos. En 1M datos, se emplea Index Scan en sede.construccion\_fecha, mejorando la eficiencia. Se usan Nested Loop y Materialize para manejar los datos masivos, con top-N heapsort para ordenar y un uso efectivo de índices. Las subconsultas siguen siendo esenciales para los filtros en todos los casos.}
            \item {\textbf{Con índices por defecto más índices personalizados}: Los planes de consulta para tablas de 1k, 10k, 100k y 1M datos muestran optimizaciones significativas. Para 1k datos, el plan comienza con un Index Scan en sede utilizando el nuevo índice, seguido de un Seq Scan en profesor\_sede y alumno para las subconsultas de conteo, realizando después un Nested Loop con director y colaborador, y finalizando con un Index Scan en persona. Para 10k datos, el plan también usa Index Scan en sede, pero las subconsultas se ejecutan más veces, resultando en múltiples Nested Loop y Index Scan, mejorando la eficiencia comparada con la versión sin índice. En 100k datos, se utiliza Index Scan en sede, y el Materialize se introduce para manejar mejor los datos, con top-N heapsort para la ordenación. Finalmente, para 1M datos, se observa un uso intensivo del Index Scan en sede, con múltiples Nested Loop, Materialize y Index Scan en otras tablas, optimizando el rendimiento significativamente. En todos los casos, las subconsultas y el uso del índice nuevo mejoran notablemente la eficiencia de la consulta.}
      \end{itemize}
\end{itemize}
\subsubsection{Planes de índices para la segunda consulta}
\begin{itemize}
      \item{Ejecución sin índices}
            \queryExecutionPlanGroup{code-snippets/query-2/query_2_unindexed.sql}{figures/query-2/query_2_unindexed_mil_datos.png}{figures/query-2/query_2_unindexed_diezmil_datos.png}{figures/query-2/query_2_unindexed_cienmil_datos.png}{figures/query-2/query_2_unindexed_mil_datos.png} % TODO: Revisar la ruta de la imagen 1 millon
      \item{Ejercución con índices por defecto}
            \queryExecutionPlanGroup{code-snippets/query-2/query_2_indexed_default.sql}{figures/query-2/query_2_indexed_default_mil_datos.png}{figures/query-2/query_2_indexed_default_diezmil_datos.png}{figures/query-2/query_2_indexed_default_cienmil_datos.png}{figures/query-2/query_2_indexed_default_millon_datos.png}
      \item{Ejecución con índices por defecto más índices personalizados}
            \queryExecutionPlanGroup{code-snippets/query-2/query_2_indexed_custom.sql}{figures/query-2/query_2_indexed_custom_mil_datos.png}{figures/query-2/query_2_indexed_custom_diezmil_datos.png}{figures/query-2/query_2_indexed_custom_cienmil_datos.png}{figures/query-2/query_2_indexed_custom_millon_datos.png}
      \item{Descripción de las ejecuciones}
      \begin{itemize}
            \item {\textbf{Sin índices}: Los planes de consulta para las tablas de 1k, 10k, 100k y 1M datos muestran diferencias significativas en la ejecución. Para 1k datos, el plan utiliza un Nested Loop Left Join entre colaborador y profesor, con un Seq Scan en colaborador y subconsultas que filtran por sede. Se realiza una materialización y un Seq Scan en persona para aplicar el filtro de nacimiento\_fecha, y un Seq Scan en profesor. Para 10k datos, se repite el uso de Nested Loop Left Join y Seq Scan en colaborador, pero con más iteraciones y materializaciones, incrementando los costos de la consulta. En 100k datos, el plan sigue siendo similar, pero se observa un aumento significativo en la cantidad de subconsultas y materializaciones necesarias. Finalmente, para 1M datos, el plan utiliza Seq Scan en persona y colaborador con múltiples Nested Loop Left Join y subconsultas, resultando en una mayor complejidad en la ejecución. En todos los casos, los Seq Scan y Nested Loop predominan, y la ausencia de índices y el uso de materializaciones incrementan los costos y la complejidad con el aumento del tamaño de los datos.}
            \item {\textbf{Con índices por defecto}: }
            \item {\textbf{Con índices por defecto más índices personalizados}: }
      \end{itemize}
\end{itemize}
\subsubsection{Planes de índices para la tercera consulta}
\begin{itemize}
	\item{Ejecución sin índices}
		\queryExecutionPlanGroup{code-snippets/query-3/query_3_unindexed.sql}{figures/query-3/query_3_unindexed_mil_datos.png}{figures/query-3/query_3_unindexed_diezmil_datos.png}{figures/query-3/query_3_unindexed_cienmil_datos.png}{figures/query-3/query_3_unindexed_millon_datos.png}
	\item{Ejecución con índices por defecto}
		\queryExecutionPlanGroup{code-snippets/query-3/query_3_indexed_default.sql}{figures/query-3/query_3_indexed_default_mil_datos.png}{figures/query-3/query_3_indexed_default_diezmil_datos.png}{figures/query-3/query_3_indexed_default_cienmil_datos.png}{figures/query-3/query_3_indexed_default_millon_datos.png}
	\item{Ejecución con índices por defecto más índices personalizados}
		\queryExecutionPlanGroup{code-snippets/query-3/query_3_indexed_custom.sql}{figures/query-3/query_3_indexed_custom_mil_datos.png}{figures/query-3/query_3_indexed_custom_diezmil_datos.png}{figures/query-3/query_3_indexed_custom_cienmil_datos.png}{figures/query-3/query_3_indexed_custom_millon_datos.png}
      \item{Descripción de las ejecuciones}
      \begin{itemize}
            \item {\textbf{Sin índices}: Aquí va el texto}
            \item {\textbf{Con índices por defecto}: Aquí va el texto}
            \item {\textbf{Con índices por defecto más índices personalizados}: Aquí va el texto}
      \end{itemize}
\end{itemize}
\subsection{Plataforma de pruebas}
\input{tables/plataforma-de-prueba-table.tex}
\subsection{Medición de tiempos}
\subsubsection{Sin índices}
\input{tables/medicion-tiempo-unindexed-tables.tex}
\subsubsection{Con índices por defecto}
\input{tables/medicion-tiempo-indexed-default-tables.tex}
\subsubsection{Con índices por defecto más índices personalizados}
\input{tables/medicion-tiempo-indexed-custom.tex}
\subsection{Resultados, análisis y discusión}
\subsubsection{Consulta 1}
% TODO: Imagen generada en Python
% TODO: Análisis y discusión
\subsubsection{Consulta 2}
% TODO: Imagen generada en Python
% TODO: Análisis y discusión
\subsubsection{Consulta 3}
% TODO: Imagen generada en Python
% TODO: Análisis y discusión